"use strict";var scratch_view=new Vue({el:"#app",data:{question:"",answer:"",user:"",allotId:"",awardWin:!1,addr_from:!1,awardName:"",awardImage:"",cardOpen:!1,gotoAddr:!1,checkAddr:!1,loading:!1,success:!1,invoice:{id:"",randomNum:""},addrForm:{username:"",phone:"",city:"",area:"",addr:"",cityInx:"",areaInx:""},citys:{},areas:{}},watch:{"addrForm.cityInx":function(e){this.addrForm.city=this.citys[e].city_id,this.areas=this.citys[e].area},"addrForm.areaInx":function(e){this.addrForm.area=this.areas[e].area_id}},methods:{getLottery:function(){var e=this,t={ReceiptId:e.invoice.id,RandomNumber:e.invoice.randomNum};return e.logger(3,{text:"call api: GetLottery",data:{Authorization:e.user,post_data:t}},"getLottery"),$.ajax({url:friendo_url+"GetLottery",method:"POST",headers:{Token:e.webToken,Authorization:e.user},data:t,success:function(t){e.logger(3,{name:"GetLottery",result:t},"getLottery")},error:function(t,r,a){console.log("error:",t.statusText),e.logger(0,{name:"GetLottery",httpStatus:r,errorMsg:t.statusText},"getLottery")},dataType:"json"})},openLottery:function(){var e=this,t={allotId:e.allotId};return e.logger(3,{text:"call api: OpenLottery",data:{Authorization:e.user,post_data:t}},"openLottery"),$.ajax({url:friendo_url+"OpenLottery",method:"POST",headers:{Token:e.webToken,Authorization:e.user},data:t,success:function(t){e.logger(3,{name:"OpenLottery",result:t},"openLottery")},error:function(t,r,a){console.log("error:",t.statusText),e.logger(0,{name:"OpenLottery",httpStatus:r,errorMsg:t.statusText},"openLottery")},dataType:"json"})},checkAddrView:function(){var e=this.addrForm;""!=e.addr&&""!=e.area&&""!=e.city?""!=e.phone&&e.phone.match(/^09[0-9]{8}$/)?""!=e.username?this.checkAddr=!0:this.error_msg="請填寫姓名":this.error_msg="請輸入手機正確格式":this.error_msg="請填寫寄送地址"},submitAddr:function(){var e=this,t=e.addrForm,r={Address:t.addr,AllotId:e.allotId,Area:t.area,CellphoneNo:t.phone,City:t.city,UserName:t.username};e.loading=!0,e.logger(3,{text:"call api: SetAwardAddress",data:{Authorization:e.user,post_data:r}},"submitAddr"),$.ajax({url:friendo_url+"SetAwardAddress",method:"POST",headers:{Token:e.webToken,Authorization:e.user},data:r,success:function(t){e.logger(3,{name:"SetAwardAddress",result:t},"submitAddr")},error:function(t,r,a){console.log("SetAwardAddress error:",t.statusText),e.gaEvant("result","scratchcard_填寫寄件資料失敗","scratchcard_填寫寄件資料失敗"),e.logger(0,{name:"SetAwardAddress",httpStatus:r,errorMsg:t.statusText},"submitAddr")},dataType:"json"}).then(function(t){e.success=!0,e.gaEvant("result","scratchcard_填寫寄件資料完成","scratchcard_填寫寄件資料完成")})},sendSMS:function(){var e=this;return $.ajax({url:friendo_url+"SendSMS",method:"POST",headers:{Token:e.webToken,Authorization:e.user},data:{ReceiptId:e.invoice.id,RandomNumber:e.invoice.randomNum},success:function(t){e.logger(3,{name:"SendSMS",result:t},"sendSMS")},error:function(t,r,a){console.log("sendSMS error:",t.statusText),e.logger(0,{name:"SetAwardAddress",httpStatus:r,errorMsg:t.statusText},"submitAddr")},dataType:"json"})},setScratch:function(e){var t=this,r=document.getElementsByClassName("card__main")[0];new ScratchCard(r,{width:535,height:363,imageForwardSrc:"images/scratch-card.png",imageBackgroundSrc:e,clearRadius:30,percentToFinish:30,open:function(){t.openLottery().then(function(){t.setCookie("_INV","",-1),t.awardWin?(t.sendSMS(),t.gaEvant("result","scratchcard_刮刮卡得獎","scratchcard_刮刮卡得獎")):t.gaEvant("result","scratchcard_刮刮卡未得獎","scratchcard_刮刮卡未得獎")})},callback:function(){t.cardOpen=!0}})}},mounted:function(){var e=this;document.getElementsByClassName("card__main")[0];if($(window).on("online offline",e.checkOnline),$("body").loadpage("init",{async:!0}),e.citys=city_json,checkCookie("_AT")&&checkCookie("_INV")){e.user=checkCookie("_AT");var t=checkCookie("_INV").split("_");e.invoice.id=t[0],e.invoice.randomNum=t[1],e.getLottery().then(function(t){t.result?"588"==t.data.ErrorCode||"0"==t.data.allotId?(e.gaEvant("result","scratchcard_領取刮刮卡失敗_ER","scratchcard_領取刮刮卡失敗_ER"),console.log(t.errorMsg),alert(t.data.ErrorMessage),window.location.href="index.html"):(e.gaEvant("result","scratchcard_領取刮刮卡成功","scratchcard_領取刮刮卡成功"),e.allotId=t.data.AllotId,e.awardWin=t.data.AwardWin,e.awardWin?e.awardImage="images/winner-pic.png":e.awardImage="images/bare-award.png",e.setScratch(e.awardImage),$("body").loadpage("close")):(e.gaEvant("result","scratchcard_領取刮刮卡失敗","scratchcard_領取刮刮卡失敗"),console.log(t.errorMsg),alert("查無此刮刮卡!"),window.location.href="index.html")})}else e.logger(2,{text:"fail invasion",AT:checkCookie("_AT"),INV:checkCookie("_INV")},"scratchCard"),window.location.href="index.html"}});