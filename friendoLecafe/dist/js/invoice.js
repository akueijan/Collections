"use strict";var invoice_view=new Vue({el:"#app",data:{checkNum:"",surveyAnswer:"",username:"",phone:"",inv_date:"10704",num:"",random_number:"",check:"",success:!1,demo:!1,step:0,verifyCode:""},computed:{inv_num:function(){return this.num.toUpperCase()}},methods:{SaveInvoice:function(){var e=this,o={cellphoneId:e.phone,Username:e.username,Id:e.inv_num,IssueDate:e.inv_date,RandomNumber:e.random_number,captcha:$("#g-recaptcha-response").val()};return e.logger(3,{text:"call api: SubmitReceipt",data:o},"SaveInvoice"),$.ajax({url:friendo_url+"SubmitReceipt",method:"POST",headers:{Token:e.webToken},data:o,success:function(o){e.logger(3,{name:"SubmitReceipt",result:o},"SaveInvoice")},error:function(o,r,t){console.log("SubmitInvoice error:",o.statusText),e.logger(0,{name:"SubmitReceipt",httpStatus:r,errorMsg:o.statusText},"SaveInvoice")},dataType:"json"})},checkSurvey:function(e){var o=this;return o.logger(3,{text:"call api: NeedSurvey",data:e},"checkSurvey"),$.ajax({url:friendo_url+"NeedSurvey",method:"POST",headers:{Token:o.webToken,Authorization:e},success:function(e){o.logger(3,{name:"NeedSurvey",result:e},"checkSurvey")},error:function(e,r,t){console.log("NeedSurvey error:",e.statusText),o.logger(0,{name:"NeedSurvey",httpStatus:r,errorMsg:e.statusText},"checkSurvey")},dataType:"json"})},getSurvey:function(){var e=this;e.setCookie("_INV",e.inv_num+"_"+e.random_number,3600),e.getAccessToken(e.phone).then(function(o){var r=o;e.checkSurvey(r).then(function(e){e.data.Done?window.location.href="scratchcard.html":window.location.href="survey.html"}).fail(function(){e.gaEvant("result","invoice_重複確認_ER","invoice_重複確認_ER"),e.error_cou--,e.error_cou>0?e.getSurvey():(e.logger(0,{name:"NeedSurvey",errorMsg:"error count > 5 out"},"checkSurvey"),e.server_busy())})})},post_code:function(){var e=this,o=void 0,r={cellphoneId:e.phone,verifyCode:e.verifyCode,cell_no:e.phone,Username:e.username,email:"",Id:e.inv_num,IssueDate:e.inv_date,RandomNumber:e.random_number};if(!e.loading&&1==e.step){var t=function(o){e.loading=!1,e.gaEvant("result","invoice_認證成功","invoice_認證成功"),e.getSurvey()};if(e.loading=!0,""==e.verifyCode)return e.error_msg="請輸入認證碼",void(e.loading=!1);e.logger(2,"set timeout for checkChode","post_code"),o=setTimeout(t,15e3),e.gaEvant("click","invoice_輸入認證碼","invoice_輸入認證碼"),e.logger(3,{text:"call api: checkOTP",data:r},"post_code"),$.ajax({url:friendo_url+"checkOTP",method:"POST",headers:{Token:e.webToken},data:r,success:function(o){e.logger(3,{name:"checkOTP",result:o},"post_code")},error:function(o,r,t){console.log("checkOTP error:",o.statusText),e.logger(0,{name:"checkOTP",httpStatus:r,errorMsg:o.statusText},"post_code")},dataType:"json"}).then(function(r){r.result?t():("500"!=result.errorCode?e.error_msg="系統忙碌中，請稍後在試!":e.error_msg="認證失敗，請重新輸入",e.gaEvant("result","invoice_認證失敗","invoice_認證失敗"),e.loading=!1),e.logger(2,"clear timeout for checkChode","post_code"),clearTimeout(o)}).fail(function(){e.error_msg="系統忙碌中，請稍後在試!",e.loading=!1,e.logger(2,"clear timeout for checkChode -> fail","post_code"),clearTimeout(o)})}},ResendSMS:function(e){var o=this;(!o.loading&&1==o.step||e)&&(o.loading=!0,o.getAccessToken(o.phone).then(function(e){o.logger(3,{text:"call api: GetOTP",data:{Authorization:e,post_data:{cellphoneId:o.phone}}},"ResendSMS"),$.ajax({url:friendo_url+"GetOTP",method:"POST",headers:{Token:o.webToken,Authorization:e},data:{cellphoneId:o.phone},success:function(e){o.logger(3,{name:"GetOTP",result:e},"ResendSMS")},error:function(e,r,t){console.log("GetOTP error:",e.statusText),o.logger(0,{name:"GetOTP",httpStatus:r,errorMsg:e.statusText},"ResendSMS"),o.error_cou--,o.error_cou>0?o.ResendSMS(!0):(o.logger(0,{name:"GetOTP",errorMsg:"error count > 5 out"},"ResendSMS"),o.server_busy())}}).then(function(){o.loading=!1,alert("已重新送出。")})}))},post_inv:function(){var e=this,o=void 0;e.checkOnline();try{if(!e.loading&&0==e.step){var r=function(o){void 0!==o?o.data?o.data.ReadyToCheck?(e.gaEvant("result","invoice_登入成功","invoice_登入成功"),e.step=1,e.loading=!1):(e.gaEvant("result","invoice_登入成功","invoice_登入成功"),e.getSurvey()):(e.gaEvant("result","invoice_登錄失敗_ER","invoice_登錄失敗_ER"),e.error_msg="系統忙碌中，請稍後在試",e.loading=!1):(e.gaEvant("result","invoice_登入成功_TO","invoice_登入成功_TO"),e.getSurvey())};e.loading=!0;if(""==e.username)return e.error_msg="請輸入使用者名稱",void(e.loading=!1);if(""==e.phone||!e.phone.match(/^09[0-9]{8}$/))return e.error_msg="請輸入手機正確格式",void(e.loading=!1);if(""==e.inv_date)return e.error_msg="請選擇發票期別",void(e.loading=!1);if(""==e.inv_num||!e.inv_num.match(/^[a-zA-Z]{2}[0-9]{8}$/))return e.error_msg="請輸入發票正確格式",void(e.loading=!1);if(""==e.random_number)return e.error_msg="請輸入發票隨機碼",void(e.loading=!1);if(1!=e.check)return e.error_msg="請勾選同意說明",void(e.loading=!1);if(""==$("#g-recaptcha-response").val())return e.error_msg="請勾選我不是機器人",void(e.loading=!1);""==e.error_msg&&(e.logger(2,"set timeout for post_inv","post_inv"),o=setTimeout(r,15e3),e.gaEvant("click","invoice_登錄發票","invoice_登錄發票"),e.SaveInvoice().then(function(t){t.result?r(t):("500"!=t.errorCode?e.error_msg="系統忙碌中，請稍後在試!":e.error_msg=t.errorMsg,e.gaEvant("result","invoice_登錄失敗","invoice_登錄失敗"),e.loading=!1,grecaptcha.reset()),e.logger(2,"clear timeout for post_inv","post_inv"),clearTimeout(o)}).fail(function(){e.gaEvant("result","invoice_登錄失敗_ER","invoice_登錄失敗_ER"),e.error_msg="系統忙碌中，請稍後在試",e.loading=!1,e.logger(2,"clear timeout for post_inv -> fail","post_inv"),clearTimeout(o)}))}}catch(o){e.loading=!1,e.logger(0,{name:"post_inv",msg:o},"post_inv")}},goBack:function(){grecaptcha.reset(),this.step=0},getMemberPhone:function(){var e=this;return e.logger(3,{text:"call api: GetMemberCellphoneNo",data:{Authorization:checkCookie("_AT")}},"getMemberPhone"),$.ajax({url:friendo_url+"GetMemberCellphoneNo",method:"POST",headers:{Token:e.webToken,Authorization:checkCookie("_AT")},data:{},success:function(o){e.logger(3,{name:"GetMemberCellphoneNo",result:o},"getMemberPhone")},error:function(o,r,t){console.log("error:",o.statusText),e.logger(0,{name:"GetMemberCellphoneNo",httpStatus:r,errorMsg:o.statusText},"getMemberPhone"),e.error_cou--,e.error_cou>0?e.getMemberPhone():(e.logger(0,{name:"GetMemberCellphoneNo",errorMsg:"error count > 5 out"},"getMemberPhone"),e.server_busy())},dataType:"json"})}},mounted:function(){var e=this;$(window).on("online offline",e.checkOnline),$("body").loadpage("init",{async:!0}),checkCookie("_AT")?e.getMemberPhone().then(function(o){o.result?(e.phone=o.data.cell_no,$("body").loadpage("close")):e.setCookie("_AT","",0)}):$("body").loadpage("close")}});